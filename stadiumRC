#!/usr/bin/python3
# License GPL 2. Copyright Paul D. Gilbert, 2017
"""
Run on race committee to set the course and distribute to racing boats.

This progam needs PYTHONPATH setting to find other modules, e.g.

export PYTHONPATH=/path/to/Vcourse/lib

Configuration for the local course setup is read from RCconfig. 
Configuration for the computer GPS setup is read from GPSconfig. 
A GUI is opened for setting a course and distributing to racing boats.
"""

__version__ = '0.0.5'

import threading
import signal
import logging
import time
import tkinter
import sys

import distribution
import RCmanagement as  mng
from RCmanagement import But

logFormat ='(%(threadName)-9s) %(message)s'
logging.basicConfig(level=logging.DEBUG, format=logFormat,)
#logging.basicConfig(level=logging.INFO, format=logFormat,)

if __name__ == '__main__':
   logging.info('main thread starting. ' +time.strftime('%Y-%m-%d %H:%M:%S %Z'))
   shutdown = threading.Event()

   dr = distribution.distributer(shutdown)
   dr.start() 
   
   logging.debug(threading.enumerate())

   race = tkinter.Tk()
   race.wm_title("RC Management")
   #race.bind('<Return>', (lambda event, e=ents: readRaceWindow(e)))   
   race.bind('<Return>', (lambda event : readRCWindow()))   

   mng.defnRCWindow(race)
   mng.writeRCWindow()
  
   But(race,  text='get RC GPS',     command=(lambda : mng.getRCgps()))
   
   But(race,  text='calc using\n RC & axis',           command=mng.calcA)
   
   But(race,  text='calc using\n RC & mark',           command=mng.calcM)
   
   But(race,  text='calc using start\n center & mark', command=mng.calcS)
   
   But(race,  text='distribute',  command=(lambda :  dr.distribute(mng.makezoneObj())))

   But(race,  text='update\nStatus',
                      command=(lambda : mng.updateStatus(race, dr.distributionRecvd())))

   But(race, text='extra',        command=(lambda : mng.extraWindow(race)))

   def abortHandler(signum, frame):
       logging.debug('main thread abortHandler setting shutdown signal.')
       shutdown.set()  # to exit threads
       time.sleep(5)   # wait as long as socket timeout in distributionHandler
       logging.info('main thread exit via abortHandler. ' +time.strftime('%Y-%m-%d %H:%M:%S %Z')+ '\n')
       logging.debug('threads running: ')
       logging.debug(threading.enumerate())
       sys.exit("stadiumRC process killed.")

   # ^C works if process is not deamonized with &
   signal.signal(signal.SIGINT,  abortHandler) # ^C, kill -2
   signal.signal(signal.SIGTERM, abortHandler) # kill -15 (default)

   race.mainloop()

   logging.debug('main thread setting shutdown signal.')
   shutdown.set()  # to exit threads
   time.sleep(5)    # wait as long as socket timeout in distributionHandler
   logging.info('main thread exit via end. ' +time.strftime('%Y-%m-%d %H:%M:%S %Z')+ '\n')
   logging.debug('threads running: ')
   logging.debug(threading.enumerate())
   sys.exit()
